var A=Object.create;var d=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var v=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var T=(s,e)=>{for(var t in e)d(s,t,{get:e[t],enumerable:!0})},w=(s,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of K(e))!k.call(s,r)&&r!==t&&d(s,r,{get:()=>e[r],enumerable:!(a=x(e,r))||a.enumerable});return s};var V=(s,e,t)=>(t=s!=null?A(v(s)):{},w(e||!s||!s.__esModule?d(t,"default",{value:s,enumerable:!0}):t,s)),N=s=>w(d({},"__esModule",{value:!0}),s);var W={};T(W,{useStorage:()=>E});module.exports=N(W);var n=require("react");var C=V(require("pify"),1);var b=()=>{try{let e=(globalThis.navigator?.userAgent).match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(e[1]==="Chrome")return parseInt(e[2])<100||globalThis.chrome.runtime?.getManifest()?.manifest_version===2}catch{return!1}return!1};var f=class{#s;#e;get primaryClient(){return this.#e}#t;get secondaryClient(){return this.#t}#r;get area(){return this.#r}get hasWebApi(){try{return typeof window<"u"&&!!window.localStorage}catch(e){return console.error(e),!1}}#a=new Map;#i;get copiedKeySet(){return this.#i}isCopied=e=>this.hasWebApi&&(this.allCopied||this.copiedKeySet.has(e));#n=!1;get allCopied(){return this.#n}getExtStorageApi=()=>globalThis.browser?.storage||globalThis.chrome?.storage;get hasExtensionApi(){try{return!!this.getExtStorageApi()}catch(e){return console.error(e),!1}}isWatchSupported=()=>this.hasExtensionApi;keyNamespace="";isValidKey=e=>e.startsWith(this.keyNamespace);getNamespacedKey=e=>`${this.keyNamespace}${e}`;getUnnamespacedKey=e=>e.slice(this.keyNamespace.length);constructor({area:e="sync",allCopied:t=!1,copiedKeyList:a=[]}={}){this.setCopiedKeySet(a),this.#r=e,this.#n=t;try{this.hasWebApi&&(t||a.length>0)&&(this.#t=window.localStorage)}catch{}try{this.hasExtensionApi&&(this.#s=this.getExtStorageApi(),b()?this.#e=(0,C.default)(this.#s[this.area],{exclude:["getBytesInUse"],errorFirst:!1}):this.#e=this.#s[this.area])}catch{}}setCopiedKeySet(e){this.#i=new Set(e)}rawGetAll=()=>this.#e?.get();getAll=async()=>{let e=await this.rawGetAll();return Object.entries(e).filter(([t])=>this.isValidKey(t)).reduce((t,[a,r])=>(t[this.getUnnamespacedKey(a)]=r,t),{})};copy=async e=>{let t=e===void 0;if(!t&&!this.copiedKeySet.has(e)||!this.allCopied||!this.hasExtensionApi)return!1;let a=this.allCopied?await this.rawGetAll():await this.#e.get((t?[...this.copiedKeySet]:[e]).map(this.getNamespacedKey));if(!a)return!1;let r=!1;for(let i in a){let o=a[i],h=this.#t?.getItem(i);this.#t?.setItem(i,o),r||=o!==h}return r};rawGet=async e=>this.hasExtensionApi?(await this.#e.get(e))[e]:this.isCopied(e)?this.#t?.getItem(e):null;rawSet=async(e,t)=>(this.isCopied(e)&&this.#t?.setItem(e,t),this.hasExtensionApi&&await this.#e.set({[e]:t}),null);clear=async(e=!1)=>{e&&this.#t?.clear(),await this.#e.clear()};rawRemove=async e=>{this.isCopied(e)&&this.#t?.removeItem(e),this.hasExtensionApi&&await this.#e.remove(e)};removeAll=async()=>{let e=await this.rawGetAll(),t=Object.keys(e);await Promise.all(t.map(this.rawRemove))};watch=e=>{let t=this.isWatchSupported();return t&&this.#o(e),t};#o=e=>{for(let t in e){let a=this.getNamespacedKey(t),r=this.#a.get(a)?.callbackSet||new Set;if(r.add(e[t]),r.size>1)continue;let i=(o,h)=>{if(h!==this.area||!o[a])return;let g=this.#a.get(a);Promise.all([this.parseValue(o[a].newValue),this.parseValue(o[a].oldValue)]).then(([p,u])=>{for(let y of g.callbackSet)y({newValue:p,oldValue:u},h)})};this.#s.onChanged.addListener(i),this.#a.set(a,{callbackSet:r,listener:i})}};unwatch=e=>{let t=this.isWatchSupported();return t&&this.#c(e),t};#c(e){for(let t in e){let a=this.getNamespacedKey(t),r=e[t];if(this.#a.has(a)){let i=this.#a.get(a);i.callbackSet.delete(r),i.callbackSet.size===0&&(this.#a.delete(a),this.#s.onChanged.removeListener(i.listener))}}}unwatchAll=()=>this.#h();#h(){this.#a.forEach(({listener:e})=>this.#s.onChanged.removeListener(e)),this.#a.clear()}async getItem(e){return this.get(e)}async setItem(e,t){await this.set(e,t)}async removeItem(e){return this.remove(e)}},m=class extends f{get=async e=>{let t=this.getNamespacedKey(e),a=await this.rawGet(t);return this.parseValue(a)};set=async(e,t)=>{let a=this.getNamespacedKey(e),r=JSON.stringify(t);return this.rawSet(a,r)};remove=async e=>{let t=this.getNamespacedKey(e);return this.rawRemove(t)};setNamespace=e=>{this.keyNamespace=e};parseValue=async e=>{try{if(e!==void 0)return JSON.parse(e)}catch(t){console.error(t)}}};var E=(s,e)=>{let t=typeof s=="object",a=t?s.key:s,[r,i]=(0,n.useState)(e),o=(0,n.useRef)(!1),h=(0,n.useRef)(e instanceof Function?e():e);(0,n.useEffect)(()=>{h.current=r},[r]);let g=(0,n.useRef)(t?s.instance:new m),p=(0,n.useCallback)(c=>g.current.set(a,c!==void 0?c:h.current),[a]),u=(0,n.useCallback)(async c=>{let l=c instanceof Function?c(h.current):c;await p(l),o.current&&i(l)},[p]);(0,n.useEffect)(()=>{o.current=!0;let c={[a]:l=>{o.current&&i(l.newValue)}};return g.current.watch(c),g.current.get(a)?.then(l=>{if(e instanceof Function){let S=e?.(l,!0);S!==void 0&&u(S)}else i(l!==void 0?l:e)}),()=>{o.current=!1,g.current.unwatch(c),e instanceof Function&&i(e)}},[a,u]);let y=(0,n.useCallback)(()=>{g.current.remove(a),i(void 0)},[a]);return[r,u,{setRenderValue:i,setStoreValue:p,remove:y}]};0&&(module.exports={useStorage});
